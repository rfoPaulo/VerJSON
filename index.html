<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Processos JSON Aprimorado</title>
    <style>
        /* LAYOUT GERAL DA PÁGINA */
        html, body {
            height: 100%;
            overflow: hidden;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f7f6;
        }

        .page-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        /* SEÇÃO SUPERIOR COMPACTA */
        .top-section {
            padding: 15px 25px;
            background-color: #ffffff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            z-index: 20;
            box-sizing: border-box;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin: 0 0 10px 0;
            font-size: 1.5em;
        }
        .status-line {
            text-align: center;
            margin: 0 0 15px 0;
            font-size: 0.9em;
            color: #333;
        }
        .top-controls {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            gap: 20px;
        }
        .control-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .filter-container {
            flex-grow: 1;
        }
        .filter-container label {
            display: block;
            font-size: 0.9em;
            color: #34495e;
            margin-bottom: 2px;
        }
        #filterInput {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .file-upload-label {
            display: inline-block;
            padding: 8px 15px;
            font-size: 0.9em;
            background-color: #3498db;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s ease;
            white-space: nowrap;
        }
        .file-upload-label:hover { background-color: #2980b9; }

        /* Estilo para o overlay de drag and drop */
        #drop-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(44, 62, 80, 0.85);
            z-index: 1000;
            display: none;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 2em;
            font-weight: bold;
            text-align: center;
            border: 4px dashed #ffffff;
            box-sizing: border-box;
        }
        #drop-overlay.show {
            display: flex;
        }


        /* DROPDOWN MENU PARA COLUNAS */
        .dropdown {
            position: relative;
        }
        .dropdown-button {
            padding: 8px 15px;
            font-size: 0.9em;
            background-color: #34495e;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            white-space: nowrap;
        }
        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: #f9f9f9;
            min-width: 200px;
            box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2);
            padding: 12px 16px;
            z-index: 100;
            max-height: 250px;
            overflow-y: auto;
            border-radius: 5px;
        }
        .dropdown-content label {
            display: block;
            font-size: 0.9em;
            padding: 5px 0;
        }
        .dropdown-content.show {
            display: block;
        }

        /* CONTAINER DA TABELA (ESPAÇO RESTANTE) */
        .table-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            padding: 15px 25px;
            box-sizing: border-box;
            min-height: 0;
        }
        #top-scrollbar-container { overflow-x: auto; overflow-y: hidden; }
        #top-scrollbar-content { height: 1px; }
        .table-responsive {
            flex-grow: 1;
            overflow: auto;
            border: 1px solid #ddd;
        }
        /* CHECKBOX*/
        input[type="checkbox" i]{
            transform: scale(1.5);
        }

        /* ESTILOS DA TABELA */
        table { width: 100%; border-collapse: collapse; }
        thead th { position: sticky; top: 0; background-color: #34495e; color: #ffffff; z-index: 10; }
        th, td { padding: 12px 15px; border: 1px solid #ddd; text-align: left; vertical-align: top; }
        th { font-weight: 600; }
        tbody tr:nth-of-type(even) { background-color: #f8f9fa; }
        tbody tr:hover { background-color: #e9ecef; }
        .row-strikethrough { text-decoration: line-through; color: #aaa; background-color: #f0f0f0 !important; }
        .row-collapsed td > div { max-height: 8em; overflow: hidden; }
        .tribunal-alert-orange { color: #d66c15; font-weight: bold; }
        .tribunal-alert-red { color: #e74c3c; font-weight: bold; }
        mark { background-color: #ff0; padding: 0.2em; }
        td pre { margin: 0; font-family: inherit; white-space: pre-wrap; }
    </style>
</head>
<body>
    <div id="drop-overlay">
        <div>Solte o arquivo JSON em qualquer lugar</div>
    </div>
    <div class="page-container">
        <div class="top-section">
            <h1>Gerador de Tabela a partir de JSON - API DJEN</h1>
            <p id="status-line" class="status-line">Aguardando arquivo...</p>
            <div class="top-controls">
                <div class="control-group">
                    <label for="jsonFile" class="file-upload-label">Selecionar Arquivo JSON</label>
                    <input type="file" id="jsonFile" accept=".json" style="display: none;">
                </div>
                <div class="filter-container">
                    <strong><label for="filterInput">Filtrar coluna 'texto' (use '&' para E, '|' para OU):</label></strong>
                    <input type="text" id="filterInput" placeholder="Digite os termos do filtro aqui...">
                </div>
                <div class="dropdown">
                    <button id="column-select-btn" class="dropdown-button">Escolher Colunas Exibidas</button>
                    <div id="columnDropdownContent" class="dropdown-content">
                        </div>
                </div>
            </div>
        </div>

        <div class="table-area">
            <div id="top-scrollbar-container">
                <div id="top-scrollbar-content"></div>
            </div>
            <div class="table-responsive">
                <table id="processosTable">
                    <thead></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script>
        let jsonData = [];
        const markedRows = new Set();

        const filterInput = document.getElementById('filterInput');
        const topScrollbar = document.getElementById('top-scrollbar-container');
        const tableWrapper = document.querySelector('.table-responsive');
        const columnSelectBtn = document.getElementById('column-select-btn');
        const columnDropdownContent = document.getElementById('columnDropdownContent');
        const statusLine = document.getElementById('status-line');
        const jsonFileInput = document.getElementById('jsonFile');
        const dropOverlay = document.getElementById('drop-overlay');


        // Lógica do Dropdown
        columnSelectBtn.addEventListener('click', () => {
            columnDropdownContent.classList.toggle('show');
        });

        window.addEventListener('click', function(event) {
            if (!event.target.matches('.dropdown-button')) {
                if (columnDropdownContent.classList.contains('show')) {
                    columnDropdownContent.classList.remove('show');
                }
            }
        });
        columnDropdownContent.addEventListener('click', function (event) {
            event.stopPropagation();
        });
        
        // Função central para processar o arquivo
        function handleFile(file) {
            if (!file) {
                statusLine.textContent = 'Nenhum arquivo selecionado';
                return;
            }
            // Permite .json ou arquivos de texto plano que podem conter o formato esperado
            if (file.type !== 'application/json' && file.type !== 'text/plain') {
                alert('Tipo de arquivo inválido! Por favor, selecione um arquivo .json ou de texto.');
                return;
            }
            
            statusLine.textContent = `Lendo o arquivo: ${file.name}...`;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const fileContent = e.target.result;
                    let processedItems = [];
                    let totalOfficialCount = 0;
                    let isOldFormat = false;

                    // Tenta analisar como um único objeto JSON (formato antigo)
                    try {
                        const singleJson = JSON.parse(fileContent);
                        if (singleJson && typeof singleJson.items !== 'undefined') {
                            isOldFormat = true;
                            processedItems = singleJson.items || [];
                            totalOfficialCount = singleJson.count || 0;
                        }
                    } catch (err) {
                        // Se falhar, assume que é o novo formato de múltiplos blocos
                        isOldFormat = false;
                    }

                    // Se não for o formato antigo, processa o novo formato
                    if (!isOldFormat) {
                        // Divide o conteúdo em blocos, usando o número do processo como delimitador.
                        // A expressão regular usa um lookahead (?=...) para manter o delimitador no início de cada bloco.
                        // O filtro remove quaisquer strings vazias que possam surgir da divisão.
                        const blocks = fileContent.split(/^\s*(?=[\d.-]{10,})/m).filter(s => s.trim() !== '');
                        let aggregatedItems = [];

                        for(const block of blocks) {
                            const lines = block.trim().split('\n');
                            const processNumber = lines.shift().trim(); // A primeira linha é o número do processo
                            const jsonString = lines.join('\n'); // O resto é o JSON
                            
                            try {
                                const blockJson = JSON.parse(jsonString);
                                // A contagem oficial é a soma de todos os 'count'
                                totalOfficialCount += blockJson.count || 0;

                                // Adiciona à tabela apenas se o 'count' do bloco for diferente de 0
                                if (blockJson && blockJson.count > 0 && Array.isArray(blockJson.items)) {
                                    const itemsWithProcessNumber = blockJson.items.map(item => ({
                                        ...item,
                                        numero_processo_principal: processNumber
                                    }));
                                    aggregatedItems.push(...itemsWithProcessNumber);
                                }
                            } catch (parseError) {
                                console.warn(`Não foi possível analisar o bloco JSON para o processo ${processNumber}:`, parseError, `\nConteúdo do bloco:`, jsonString);
                            }
                        }
                        processedItems = aggregatedItems;
                    }
                    
                    jsonData = processedItems;
                    const itemCount = jsonData.length;

                    // ATUALIZA A LINHA DE STATUS
                    statusLine.innerHTML = `<strong>Arquivo:</strong> ${file.name} | <strong>Linhas na Tabela:</strong> ${itemCount} | <strong>Contagem Oficial (soma):</strong> ${totalOfficialCount}`;
                    
                    // Alerta de divergência apenas para o formato antigo, onde a contagem deve bater
                    if (isOldFormat && itemCount !== totalOfficialCount) {
                        statusLine.style.color = '#e74c3c'; 
                        alert(`Atenção: O número de linhas na tabela (${itemCount}) é diferente da contagem oficial no arquivo (${totalOfficialCount}).`);
                    } else {
                        statusLine.style.color = '#333'; 
                    }
                    
                    markedRows.clear(); 
                    filterInput.value = '';

                    populateColumnSelector(jsonData);
                    renderTable();
                    setupScrollSync();

                } catch (error) {
                    statusLine.textContent = `Erro: ${error.message}`;
                    alert(`Ocorreu um erro ao processar o arquivo: ${error.message}`);
                }
            };
            reader.readAsText(file);
        }


        // Evento de clique no input
        jsonFileInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            handleFile(file);
        });

        // --- LÓGICA DE DRAG AND DROP NA TELA INTEIRA ---
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            document.body.addEventListener(eventName, e => {
                e.preventDefault();
                e.stopPropagation();
            });
        });

        let dragCounter = 0; // Previne que o evento 'dragleave' dispare em elementos filhos

        document.body.addEventListener('dragenter', (e) => {
            dragCounter++;
            dropOverlay.classList.add('show');
        });

        document.body.addEventListener('dragleave', (e) => {
            dragCounter--;
            if (dragCounter === 0) {
                dropOverlay.classList.remove('show');
            }
        });

        document.body.addEventListener('drop', (event) => {
            event.preventDefault();
            dragCounter = 0;
            dropOverlay.classList.remove('show');
            
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                // Atribui o arquivo solto ao input para consistência
                jsonFileInput.files = files;
                handleFile(files[0]);
            }
        });


        function populateColumnSelector(data) {
            const container = document.getElementById('columnDropdownContent');
            container.innerHTML = '';
            if (data.length === 0) return;

            const allKeys = new Set();
            data.forEach(item => {
                Object.keys(item).forEach(key => allKeys.add(key));
            });

            
            const defaultColumns = ["siglaTribunal", "nomeOrgao", "texto", "numeroprocessocommascara", "nomeClasse"];

            Array.from(allKeys).forEach(key => { 
                const label = document.createElement('label');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = key;
                checkbox.checked = defaultColumns.includes(key);
                checkbox.addEventListener('change', () => {
                    renderTable();
                    setupScrollSync();
                });
                
                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(` ${key}`));
                container.appendChild(label);
            });
        }
        
        function escapeRegExp(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function highlightText(text, terms) {
            if (!terms || terms.length === 0 || !text) return text;
            const regex = new RegExp(`(${terms.map(escapeRegExp).join('|')})`, 'gi');
            return text.replace(regex, '<mark>$1</mark>');
        }

        function renderTable() {
            const table = document.getElementById('processosTable');
            let thead = table.querySelector('thead');
            let tbody = table.querySelector('tbody');

            if (!thead) {
                thead = document.createElement('thead');
                table.appendChild(thead);
            }
            if (!tbody) {
                tbody = document.createElement('tbody');
                table.appendChild(tbody);
            }
            
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            const selectedColumns = Array.from(document.querySelectorAll('#columnDropdownContent input:checked')).map(cb => cb.value);

            const headerRow = thead.insertRow();
            ['Nº', 'Riscar'].concat(selectedColumns).forEach(text => {
                const th = document.createElement('th');
                th.textContent = text;
                headerRow.appendChild(th);
            });

            const filterQuery = filterInput.value.trim().toLowerCase();
            const uniqueTerms = filterQuery ? [...new Set(filterQuery.split(/[&|]/).map(s => s.trim()).filter(Boolean))] : [];

            jsonData.forEach((item, index) => {
                let shouldRender = true;
                if (filterQuery) {
                    const textToSearch = (item.texto || '').toLowerCase();
                    const orGroups = filterQuery.split('|').map(s => s.trim());
                    shouldRender = orGroups.some(orGroup => {
                        const andTerms = orGroup.split('&').map(s => s.trim()).filter(Boolean);
                        if (andTerms.length === 0 && orGroups.length > 1) return true;
                        if(andTerms.length === 0) return textToSearch.includes(orGroup);
                        return andTerms.every(andTerm => textToSearch.includes(andTerm));
                    });
                }
                
                if (!shouldRender) return;

                const row = tbody.insertRow();
                
                row.insertCell().textContent = index + 1;

                const tdCheck = row.insertCell();
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.addEventListener('change', (e) => {
                    row.classList.toggle('row-strikethrough', e.target.checked);
                    row.classList.toggle('row-collapsed', e.target.checked);
                    if (e.target.checked) markedRows.add(index);
                    else markedRows.delete(index);
                });
                tdCheck.appendChild(checkbox);
                
                if (markedRows.has(index)) {
                    checkbox.checked = true;
                    row.classList.add('row-strikethrough', 'row-collapsed');
                }

                selectedColumns.forEach(col => {
                    const td = row.insertCell();
                    const contentDiv = document.createElement('div');
                    let content = item[col];

                    if (content == null) {
                        content = '';
                    }

                    if (Array.isArray(content)) {
                        if (col === 'destinatarios' && content.length > 0) {
                            contentDiv.innerHTML = content.map(dest => `${dest.nome || 'N/A'} (Polo: ${dest.polo || 'N/A'})`).join('<br>');
                        } else if (col === 'destinatarioadvogados' && content.length > 0) {
                            contentDiv.innerHTML = content.map(adv => {
                                if (adv.advogado) {
                                    return `${adv.advogado.nome || 'N/A'} (OAB: ${adv.advogado.numero_oab || 'N/A'}/${adv.advogado.uf_oab || 'N/A'})`;
                                }
                                return 'Advogado inválido';
                            }).join('<br>');
                        } else {
                            contentDiv.innerHTML = `<pre>${JSON.stringify(content, null, 2)}</pre>`;
                        }
                    } else if (typeof content === 'object' && content !== null) {
                        contentDiv.innerHTML = `<pre>${JSON.stringify(content, null, 2)}</pre>`;
                    } else {
                        content = String(content);
                        if (col === 'texto' && uniqueTerms.length > 0) {
                            contentDiv.innerHTML = highlightText(content, uniqueTerms);
                        } else if (col === 'siglaTribunal' && typeof content === 'string' && !content.includes('TRT')) {
                            contentDiv.innerHTML = `<span class="tribunal-alert-red">${content}</span>`;
                        } else if (col === 'siglaTribunal' && typeof content === 'string' && !content.includes('TRT4')) {
                            contentDiv.innerHTML = `<span class="tribunal-alert-orange">${content}</span>`;
                        } else {
                            contentDiv.innerHTML = content;
                        }
                    }
                    td.appendChild(contentDiv);
                });
            });
        }
        
        function setupScrollSync() {
            const table = document.getElementById('processosTable');
            const topScrollContent = document.getElementById('top-scrollbar-content');
            if (!table) return;
            
            topScrollContent.style.width = `${table.scrollWidth}px`;
            
            topScrollbar.onscroll = () => { tableWrapper.scrollLeft = topScrollbar.scrollLeft; };
            tableWrapper.onscroll = () => { topScrollbar.scrollLeft = tableWrapper.scrollLeft; };
        }
        
        filterInput.addEventListener('input', renderTable);
    </script>
</body>
</html>

